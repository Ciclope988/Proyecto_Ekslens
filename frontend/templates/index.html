<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
        <title>EKSLENS - Lead Generation System v2.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            width: 100vw;
            max-width: 100vw;
            margin: 0;
            padding: 0 2vw;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1vw;
        }

        .status-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .status-item i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }

        .status-item.connected i { color: #48bb78; }
        .status-item.warning i { color: #ed8936; }
        .status-item.info i { color: #4299e1; }

        .main-content {
            display: grid;
            grid-template-columns: 48vw 48vw;
            gap: 2vw;
            margin-bottom: 2vh;
            justify-content: center;
        }

        .main-content .card {
            width: 100%;
            box-sizing: border-box;
        }

        /* Secciones de ancho completo - siempre ocupan todo el viewport */
        .full-width-section {
            width: 96vw;
            margin: 2vh auto;
            box-sizing: border-box;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1vw;
            padding: 2vw;
            box-shadow: 0 0.5vh 2vh rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            margin-right: 10px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 85, 104, 0.4);
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-linkedin {
            background: linear-gradient(135deg, #0077b5 0%, #005885 100%);
            color: white;
            margin-left: 10px;
        }

        .btn-linkedin:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 119, 181, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Secciones de ancho completo */
        .full-width-section {
            width: 100%;
            margin: 1.25rem 0;
            flex: 1 1 100%;
        }

        /* Estilos espec√≠ficos para botones del formulario de leads manuales */
        .manual-lead-buttons {
            display: flex;
            gap: 0.9375rem;
            justify-content: flex-end;
            margin-top: 1.25rem;
            padding-top: 0.9375rem;
            border-top: 0.125rem solid #e2e8f0;
        }

        .manual-lead-buttons .btn {
            min-width: 10rem;
            padding: 0.75rem 1.5625rem;
            font-size: 0.9375rem;
        }

        @media (max-width: 768px) {
            .manual-lead-buttons {
                flex-direction: column-reverse;
                align-items: stretch;
            }
            
            .manual-lead-buttons .btn {
                min-width: auto;
                width: 100%;
            }
        }

        /* Estilos para campos de formulario con focus */
        #quickLeadForm input:focus,
        #quickLeadForm textarea:focus {
            outline: none;
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
        }

        /* Efectos hover para mejorar UX */
        #quickLeadForm input:hover,
        #quickLeadForm textarea:hover {
            border-color: #c6d3ff !important;
        }

        /* Estilo del resultado del formulario */
        #quickLeadResult .success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #b8dabd;
            font-weight: 500;
        }

        #quickLeadResult .error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #f1b5bb;
            font-weight: 500;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }

        .logs-container {
            grid-column: 1 / -1;
            max-height: 400px;
            overflow-y: auto;
            background: #1a202c;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #2d3748;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-timestamp {
            color: #a0aec0;
            margin-right: 10px;
        }

        .log-info { color: #4299e1; }
        .log-success { color: #48bb78; }
        .log-warning { color: #ed8936; }
        .log-error { color: #f56565; }

        .results-container {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .lead-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #48bb78;
        }

        .lead-name {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .lead-source {
            font-size: 12px;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .lead-description {
            font-size: 14px;
            color: #718096;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #e53e3e;
            border: 1px solid #feb2b2;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #666;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .modal-content .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Layout fijo - sin media queries para mantener consistencia en todos los zooms */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1vw;
            margin-bottom: 2vh;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-search"></i> EKSLENS AESTHETICS </h1>
            <p>Buscador de clientes automatizado</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-grid">
                <div class="status-item" id="db-status">
                    <i class="fas fa-database"></i>
                    <div>Base de Datos</div>
                    <div id="db-status-text">Verificando...</div>
                </div>
                <div class="status-item info">
                    <i class="fas fa-chart-bar"></i>
                    <div>Total Leads</div>
                    <div id="total-leads">0</div>
                </div>
                <div class="status-item info">
                    <i class="fas fa-envelope"></i>
                    <div>Emails Generados</div>
                    <div id="total-emails">0</div>
                </div>
                <div class="status-item warning">
                    <i class="fas fa-search"></i>
                    <div>B√∫squedas SerpApi</div>
                    <div id="serpapi-remaining">Cargando...</div>
                </div>
                <div class="status-item info">
                    <i class="fab fa-linkedin"></i>
                    <div>Invites LinkedIn</div>
                    <div id="linkedin-invites">0</div>
                </div>
                <div class="status-item info">
                    <i class="fab fa-instagram"></i>
                    <div>Invites Instagram</div>
                    <div id="instagram-invites">0</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Control Panel -->
            <div class="card">
                <h2><i class="fas fa-cog"></i> Panel de Control</h2>
                
                <div class="form-group">
                    <label for="industry">Industria objetivo:</label>
                    <select id="industry" onchange="changeIndustry()">
                        <option value="medical_aesthetics">Medicina Est√©tica</option>
                    </select>
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        üè• Sistema especializado en medicina est√©tica
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="cities">Ciudades a buscar (o pa√≠s):</label>
                    <input type="text" id="cities" placeholder="madrid, barcelona, valencia" value="">
                </div>

                <div class="form-group">
                    <label for="keywords">Palabras clave de b√∫squeda (separadas por coma):</label>
                    <input type="text" id="keywords" placeholder="botox, restylane, profhilo, gouri, fillers" value="">
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                        üí° Ejemplos: "gouri", "restylane", "profhilo", "botox", "hyaluronic acid"
                    </small>
                </div>

                <div class="form-group">
                    <label for="max-searches">N√∫mero de b√∫squedas SerpApi:</label>
                    <select id="max-searches">
                        <option value="1">1 b√∫squeda (conservador)</option>
                        <option value="2">2 b√∫squedas (recomendado)</option>
                        <option value="3" selected>3 b√∫squedas (est√°ndar)</option>
                        <option value="5">5 b√∫squedas (intensivo)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Fuentes a utilizar:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="use-serpapi" checked>
                            <label for="use-serpapi">SerpApi (Google Search)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="use-linkedin" disabled>
                            <label for="use-linkedin" style="color: #999; text-decoration: line-through;">LinkedIn Premium (Deshabilitado)</label>
                            <small style="color: #e53e3e; display: block; font-size: 11px; margin-top: 5px;">
                                ‚ö†Ô∏è Temporalmente deshabilitado por pol√≠ticas de uso
                            </small>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="use-instagram">
                            <label for="use-instagram">Instagram</label>
                        </div>
                    </div>
                </div>

                <div class="progress-bar hidden" id="progress-container">
                    <div class="progress-fill" id="progress-bar"></div>
                </div>

                <div id="status-message" class="alert alert-success hidden"></div>

                <button class="btn btn-secondary" id="preview-btn" onclick="previewOptimization()">
                    <i class="fas fa-eye"></i> Vista Previa de B√∫squeda
                </button>

                <button class="btn btn-primary" id="start-btn" onclick="startSearch()">
                    <i class="fas fa-play"></i> Iniciar B√∫squeda
                </button>

                <button class="btn btn-danger hidden" id="stop-btn" onclick="stopSearch()">
                    <i class="fas fa-stop"></i> Detener
                </button>

                <button class="btn btn-linkedin hidden" id="linkedin-invite-btn" onclick="showLinkedInInviteModal()">
                    <i class="fab fa-linkedin"></i> Enviar Invitaciones LinkedIn
                </button>
            </div>

            <!-- Agregar Lead Manual Section -->
            <div class="card">
                <h2><i class="fab fa-linkedin"></i> Agregar Lead Manual de LinkedIn</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    üéØ Agrega contactos de LinkedIn que hayas encontrado manualmente para trackear el ROI por fuente.
                </p>
                
                <form id="quickLeadForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: end;">
                    <div>
                        <label for="quick-nombre" style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre *</label>
                        <input type="text" id="quick-nombre" name="nombre" required placeholder="Ej: Dr. Mar√≠a L√≥pez" 
                               style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;">
                    </div>
                    
                    <div>
                        <label for="quick-email" style="display: block; margin-bottom: 5px; font-weight: 600;">Email</label>
                        <input type="email" id="quick-email" name="email" placeholder="maria@clinica.com"
                               style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;">
                    </div>
                    
                    <div>
                        <label for="quick-telefono" style="display: block; margin-bottom: 5px; font-weight: 600;">Tel√©fono</label>
                        <input type="tel" id="quick-telefono" name="telefono" placeholder="+34 123 456 789"
                               style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;">
                    </div>
                    
                    <div style="grid-column: 1 / -1;">
                        <label for="quick-linkedin" style="display: block; margin-bottom: 5px; font-weight: 600;">LinkedIn URL</label>
                        <input type="url" id="quick-linkedin" name="linkedin_url" placeholder="https://linkedin.com/in/maria-lopez"
                               style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;">
                    </div>
                    
                    <div style="grid-column: 1 / -1;">
                        <label for="quick-description" style="display: block; margin-bottom: 5px; font-weight: 600;">Descripci√≥n</label>
                        <textarea id="quick-description" name="description" rows="2" placeholder="Directora de cl√≠nica est√©tica, especialista en..."
                                  style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="grid-column: 1 / -1; display: flex; flex-direction: column; gap: 12px; margin-top: 20px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                        <button type="submit" class="btn btn-success" style="width: 100%;">
                            <i class="fas fa-save"></i> Guardar Lead Manual
                        </button>
                        <button type="reset" class="btn btn-secondary" style="width: 100%;">
                            <i class="fas fa-eraser"></i> Limpiar
                        </button>
                    </div>
                </form>
                
                <div id="quickLeadResult" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- Database Stats - Full Width -->
        <div class="card full-width-section">
            <h2><i class="fas fa-chart-line"></i> Estad√≠sticas del Sistema</h2>
            
            <div id="stats-content">
                <p>Cargando estad√≠sticas...</p>
            </div>

            <button class="btn btn-primary" onclick="refreshStats()" style="margin-top: 15px;">
                <i class="fas fa-refresh"></i> Actualizar
            </button>
        </div>

        <!-- Results Section -->
        <div class="results-container hidden" id="results-container">
            <div class="card">
                <h2><i class="fas fa-trophy"></i> Resultados de la B√∫squeda</h2>
                <div id="results-content"></div>
            </div>
        </div>

        <!-- Logs Container -->
        <div class="logs-container hidden" id="logs-container">
            <h3 style="color: #e2e8f0; margin-bottom: 15px;">
                <i class="fas fa-terminal"></i> Logs en Tiempo Real
            </h3>
            <div id="logs-content"></div>
        </div>

        <!-- Database Query Section - Full Width -->
        <div class="logs-container full-width-section" id="database-query-container">
            <div class="card">
                <h3 style="color: #2d3748; margin-bottom: 15px;">
                    <i class="fas fa-database"></i> Consultas de Base de Datos
                </h3>
                <p style="color: #4a5568; margin-bottom: 20px; font-size: 14px;">
                    üí° Ejecuta consultas SQL personalizadas para analizar tus leads
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label for="sql-query" style="display: block; margin-bottom: 8px; color: #2d3748; font-weight: 600;">
                            <i class="fas fa-code"></i> Consulta SQL
                        </label>
                        <textarea id="sql-query" placeholder="SELECT * FROM leads WHERE source = 'LinkedIn (Manual)' ORDER BY created_at DESC LIMIT 10" 
                                  style="width: 100%; height: 100px; padding: 12px; background: #f7fafc; color: #2d3748; border: 2px solid #e2e8f0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="executeQuery()" class="btn btn-primary" style="min-width: 120px;">
                            <i class="fas fa-play"></i> Ejecutar
                        </button>
                        <button onclick="clearQueryResults()" class="btn btn-secondary" style="min-width: 120px;">
                            <i class="fas fa-trash"></i> Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- Quick Query Buttons -->
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d3748; margin-bottom: 10px; font-size: 16px;">
                        <i class="fas fa-bolt"></i> Consultas R√°pidas
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button onclick="setQuickQuery('allLeads')" class="btn btn-secondary" style="font-size: 12px;">
                            üìä Todos los Leads
                        </button>
                        <button onclick="setQuickQuery('linkedinManual')" class="btn btn-secondary" style="font-size: 12px;">
                            üîó LinkedIn Manual
                        </button>
                        <button onclick="setQuickQuery('bySource')" class="btn btn-secondary" style="font-size: 12px;">
                            üìà Por Fuente
                        </button>
                        <button onclick="setQuickQuery('recentLeads')" class="btn btn-secondary" style="font-size: 12px;">
                            ‚è∞ Leads Recientes
                        </button>
                        <button onclick="setQuickQuery('withEmail')" class="btn btn-secondary" style="font-size: 12px;">
                            üìß Con Email
                        </button>
                        <button onclick="setQuickQuery('withPhone')" class="btn btn-secondary" style="font-size: 12px;">
                            üìû Con Tel√©fono
                        </button>
                    </div>
                </div>
                
                <!-- Query Results -->
                <div style="margin-top: 20px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px; font-size: 16px;">
                        <i class="fas fa-table"></i> Resultados
                    </h4>
                    <div id="query-results" style="background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; min-height: 100px; color: #4a5568;">
                        üí° Los resultados aparecer√°n aqu√≠...
                    </div>
                </div>
            </div>
        </div>
                        <i class="fas fa-bolt"></i> Consultas R√°pidas
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="setQuickQuery('allLeads')" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            üìä Todos los Leads
                        </button>
                        <button onclick="setQuickQuery('linkedinManual')" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            üîó LinkedIn Manual
                        </button>
                        <button onclick="setQuickQuery('bySource')" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            üìà Por Fuente
                        </button>
                        <button onclick="setQuickQuery('recentLeads')" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            ‚è∞ Recientes
                        </button>
                        <button onclick="setQuickQuery('withEmail')" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            üìß Con Email
                        </button>
                        <button onclick="setQuickQuery('withPhone')" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;">
                            üìû Con Tel√©fono
                        </button>
                    </div>
                </div>
                
                <!-- Query Results -->
                <div id="query-results" style="background: #1a202c; border-radius: 8px; border: 1px solid #4a5568; min-height: 100px; padding: 15px; color: #e2e8f0; font-family: 'Courier New', monospace; font-size: 12px; overflow-x: auto; white-space: pre-wrap;">
                    üí° Los resultados aparecer√°n aqu√≠...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar lead manual -->
    <div id="addManualLeadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAddManualLeadModal()">&times;</span>
            <h2><i class="fab fa-linkedin"></i> Agregar Lead de LinkedIn Manual</h2>
            <p>Agrega contactos de LinkedIn que hayas encontrado manualmente para trackear el ROI por fuente.</p>
            
            <form id="manualLeadForm">
                <div class="form-group">
                    <label for="manual-nombre">Nombre *</label>
                    <input type="text" id="manual-nombre" name="nombre" required placeholder="Nombre completo del contacto">
                </div>
                
                <div class="form-group">
                    <label for="manual-email">Email</label>
                    <input type="email" id="manual-email" name="email" placeholder="email@ejemplo.com">
                </div>
                
                <div class="form-group">
                    <label for="manual-telefono">Tel√©fono</label>
                    <input type="tel" id="manual-telefono" name="telefono" placeholder="+34 123 456 789">
                </div>
                
                <div class="form-group">
                    <label for="manual-linkedin">LinkedIn URL</label>
                    <input type="url" id="manual-linkedin" name="linkedin_url" placeholder="https://linkedin.com/in/contacto">
                </div>
                
                <div class="form-group">
                    <label for="manual-description">Descripci√≥n</label>
                    <textarea id="manual-description" name="description" rows="3" placeholder="Informaci√≥n adicional, empresa, cargo, etc."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="closeAddManualLeadModal()" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar Lead
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let updateInterval;
        let isSearching = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            loadDatabaseStats();
        });

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update database status
                const dbStatus = document.getElementById('db-status');
                const dbStatusText = document.getElementById('db-status-text');
                
                if (data.database_connected) {
                    dbStatus.className = 'status-item connected';
                    dbStatusText.textContent = 'Conectada';
                } else {
                    dbStatus.className = 'status-item warning';
                    dbStatusText.textContent = 'Desconectada';
                }
                
                // Update stats
                document.getElementById('total-leads').textContent = data.total_leads || 0;
                document.getElementById('total-emails').textContent = data.total_emails || 0;
                document.getElementById('serpapi-remaining').textContent = `${data.serpapi_remaining} restantes`;
                document.getElementById('linkedin-invites').textContent = data.linkedin_invites_sent || 0;
                document.getElementById('instagram-invites').textContent = data.instagram_invites_sent || 0;
                
                // Update search status
                if (data.is_running && !isSearching) {
                    startProgressUpdates();
                } else if (!data.is_running && isSearching) {
                    stopProgressUpdates();
                }
                
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/database_stats');
                const data = await response.json();
                
                const statsContent = document.getElementById('stats-content');
                
                if (response.ok) {
                    let html = `
                        <!-- Estad√≠sticas principales en formato horizontal compacto -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${data.total_leads || 0}</div>
                                <div style="font-size: 12px; opacity: 0.9;"><i class="fas fa-users"></i> Total Leads</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${data.total_emails || 0}</div>
                                <div style="font-size: 12px; opacity: 0.9;"><i class="fas fa-envelope"></i> Emails</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${Object.keys(data.leads_by_source || {}).length}</div>
                                <div style="font-size: 12px; opacity: 0.9;"><i class="fas fa-chart-pie"></i> Fuentes</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">${data.leads_by_source && data.leads_by_source['LinkedIn (Manual)'] || 0}</div>
                                <div style="font-size: 12px; opacity: 0.9;"><i class="fab fa-linkedin"></i> Manual</div>
                            </div>
                        </div>
                    `;
                    
                    // Leads por fuente y estado en layout horizontal
                    html += `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="margin-bottom: 12px; color: #4a5568; font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                                    <i class="fas fa-chart-bar"></i> Por Fuente
                                </h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    `;
                    
                    for (const [source, count] of Object.entries(data.leads_by_source || {})) {
                        const badgeColors = {
                            'LinkedIn (Manual)': 'background: #0077b5; color: white;',
                            'SerpApi': 'background: #4285f4; color: white;', 
                            'Instagram': 'background: #e4405f; color: white;',
                            'default': 'background: #718096; color: white;'
                        };
                        const badgeStyle = badgeColors[source] || badgeColors.default;
                        
                        html += `
                            <span style="${badgeStyle} padding: 6px 12px; border-radius: 15px; font-size: 13px; font-weight: 500;">
                                ${source}: ${count}
                            </span>
                        `;
                    }
                    
                    html += `
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 12px; color: #4a5568; font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                                    <i class="fas fa-tasks"></i> Por Estado
                                </h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    `;
                    
                    for (const [status, count] of Object.entries(data.leads_by_status || {})) {
                        const statusColors = {
                            'pending': 'background: #ed8936; color: white;',
                            'contacted': 'background: #48bb78; color: white;',
                            'closed': 'background: #38b2ac; color: white;',
                            'default': 'background: #a0aec0; color: white;'
                        };
                        const statusStyle = statusColors[status] || statusColors.default;
                        
                        html += `
                            <span style="${statusStyle} padding: 6px 12px; border-radius: 15px; font-size: 13px; font-weight: 500;">
                                ${status}: ${count}
                            </span>
                        `;
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Recent leads en formato m√°s compacto
                    if (data.recent_leads && data.recent_leads.length > 0) {
                        html += `
                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 12px; color: #4a5568; font-size: 16px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                                    <i class="fas fa-clock"></i> √öltimos Leads (${data.recent_leads.length})
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; max-height: 150px; overflow-y: auto;">
                        `;
                        
                        for (const lead of data.recent_leads.slice(0, 6)) { // Mostrar solo los primeros 6
                            const linkedinLink = lead.linkedin_url ? 
                                `<a href="${lead.linkedin_url.startsWith('http') ? lead.linkedin_url : 'https://' + lead.linkedin_url}" target="_blank" style="color: #0077b5; text-decoration: none; margin-left: 8px;" title="Ver LinkedIn"><i class="fab fa-linkedin"></i></a>` : '';
                            
                            const emailLink = lead.email ? 
                                `<a href="mailto:${lead.email}" style="color: #28a745; text-decoration: none; margin-left: 8px;" title="Enviar email"><i class="fas fa-envelope"></i></a>` : '';
                            
                            const phoneLink = (lead.telefono || lead.phone) ? 
                                `<a href="tel:${lead.telefono || lead.phone}" style="color: #007bff; text-decoration: none; margin-left: 8px;" title="Llamar"><i class="fas fa-phone"></i></a>` : '';
                            
                            html += `
                                <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; border-left: 4px solid #48bb78;">
                                    <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px; font-size: 14px;">${lead.name}</div>
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${lead.source}</span>
                                        <div>${linkedinLink}${emailLink}${phoneLink}</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                    
                    statsContent.innerHTML = html;
                } else {
                    statsContent.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats-content').innerHTML = 
                    '<div class="alert alert-error">Error cargando estad√≠sticas</div>';
            }
        }

        async function startSearch() {
            const cities = document.getElementById('cities').value.split(',').map(c => c.trim());
            const keywords = document.getElementById('keywords').value.split(',').map(k => k.trim());
            const maxSearches = parseInt(document.getElementById('max-searches').value);
            const useSerpapi = document.getElementById('use-serpapi').checked;
            const useLinkedin = false; // Forzado a false por pol√≠ticas de uso
            const useInstagram = document.getElementById('use-instagram').checked;
            
            if (cities.length === 0 || cities[0] === '') {
                alert('Por favor, ingresa al menos una ciudad');
                return;
            }
            
            if (keywords.length === 0 || keywords[0] === '') {
                alert('Por favor, ingresa al menos una palabra clave');
                return;
            }
            
            try {
                const response = await fetch('/api/start_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cities: cities,
                        keywords: keywords,
                        max_searches: maxSearches,
                        use_serpapi: useSerpapi,
                        use_linkedin: useLinkedin,
                        use_instagram: useInstagram
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    startProgressUpdates();
                    showStatusMessage(data.message, 'success');
                } else {
                    showStatusMessage(data.error, 'error');
                }
            } catch (error) {
                console.error('Error starting search:', error);
                showStatusMessage('Error iniciando b√∫squeda', 'error');
            }
        }

        async function stopSearch() {
            try {
                const response = await fetch('/api/stop_search', {
                    method: 'POST'
                });
                
                const data = await response.json();
                showStatusMessage(data.message, 'success');
                stopProgressUpdates();
            } catch (error) {
                console.error('Error stopping search:', error);
            }
        }

        function startProgressUpdates() {
            isSearching = true;
            
            // Update UI
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').classList.remove('hidden');
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('logs-container').classList.remove('hidden');
            
            // Start polling for updates
            updateInterval = setInterval(updateProgress, 2000);
        }

        function stopProgressUpdates() {
            isSearching = false;
            
            // Update UI
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').classList.add('hidden');
            
            // Stop polling
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // Load results
            loadResults();
            updateStatus();
            loadDatabaseStats();
        }

        async function updateProgress() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                // Update progress bar
                document.getElementById('progress-bar').style.width = `${data.progress}%`;
                
                // Update logs
                const logsContent = document.getElementById('logs-content');
                logsContent.innerHTML = '';
                
                for (const log of data.logs.slice(-20)) { // Show last 20 logs
                    const logDiv = document.createElement('div');
                    logDiv.className = `log-entry log-${log.level.toLowerCase()}`;
                    logDiv.innerHTML = `
                        <span class="log-timestamp">[${log.timestamp}]</span>
                        <span class="log-${log.level.toLowerCase()}">${log.message}</span>
                    `;
                    logsContent.appendChild(logDiv);
                }
                
                // Auto-scroll to bottom
                logsContent.scrollTop = logsContent.scrollHeight;
                
                // Check if search completed
                if (!data.is_running && isSearching) {
                    stopProgressUpdates();
                }
                
            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        async function loadResults() {
            try {
                const response = await fetch('/api/results');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const resultsContainer = document.getElementById('results-container');
                    const resultsContent = document.getElementById('results-content');
                    
                    let html = `
                        <div class="results-grid">
                            <div class="result-card">
                                <h4><i class="fas fa-chart-bar"></i> Resumen</h4>
                                <p><strong>Total Leads:</strong> ${data.total_leads}</p>
                                <p><strong>SerpApi:</strong> ${data.serpapi_leads}</p>
                                <p><strong>LinkedIn:</strong> ${data.linkedin_leads}</p>
                                <p><strong>Emails IA:</strong> ${data.ai_emails}</p>
                            </div>
                            <div class="result-card">
                                <h4><i class="fas fa-clock"></i> Rendimiento</h4>
                                <p><strong>Tiempo:</strong> ${(data.execution_summary?.execution_time_seconds || 0).toFixed(1)}s</p>
                                <p><strong>Eficiencia:</strong> ${(data.execution_summary?.efficiency_leads_per_minute || 0).toFixed(1)} leads/min</p>
                            </div>
                        </div>
                    `;
                    
                    if (data.sample_leads && data.sample_leads.length > 0) {
                        html += `
                            <h4 style="margin-top: 20px;"><i class="fas fa-star"></i> Muestra de Leads Encontrados</h4>
                        `;
                        
                        for (const lead of data.sample_leads) {
                            html += `
                                <div class="lead-item">
                                    <div class="lead-name">${lead.name}</div>
                                    <span class="lead-source">${lead.source}</span>
                                    <div class="lead-description">${lead.description}</div>
                                    ${lead.website ? `<div style="font-size: 12px; color: #4299e1; margin-top: 5px;">${lead.website}</div>` : ''}
                                </div>
                            `;
                        }
                    }
                    
                    // Mostrar bot√≥n de LinkedIn si hay leads de LinkedIn
                    if (data.linkedin_leads > 0) {
                        html += `
                            <div style="text-align: center; margin-top: 20px;">
                                <button id="linkedin-invite-btn" onclick="openLinkedInInviteModal()" class="btn btn-primary">
                                    <i class="fab fa-linkedin"></i> Enviar Invitaciones LinkedIn
                                </button>
                            </div>
                        `;
                    }
                    
                    resultsContent.innerHTML = html;
                    resultsContainer.classList.remove('hidden');
                    
                } else {
                    console.log('No results available yet');
                }
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        function refreshStats() {
            updateStatus();
            loadDatabaseStats();
        }

        function showStatusMessage(message, type) {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.className = `alert alert-${type}`;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }

        async function previewOptimization() {
            const cities = document.getElementById('cities').value;
            const keywords = document.getElementById('keywords').value;
            
            if (!cities.trim()) {
                alert('Por favor ingresa las ciudades primero');
                return;
            }
            
            if (!keywords.trim()) {
                alert('Por favor ingresa las palabras clave primero');
                return;
            }
            
            const previewBtn = document.getElementById('preview-btn');
            previewBtn.disabled = true;
            previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando...';
            
            try {
                const response = await fetch('/api/optimize_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        cities: cities,
                        keywords: keywords 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showOptimizationPreview(data.optimization);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            } finally {
                previewBtn.disabled = false;
                previewBtn.innerHTML = '<i class="fas fa-eye"></i> Vista Previa de B√∫squeda';
            }
        }
        
        function showOptimizationPreview(optimization) {
            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #2d3748; margin-bottom: 15px;">
                        <i class="fas fa-search"></i> Vista Previa de Optimizaci√≥n
                    </h3>
            `;
            
            optimization.forEach((city, index) => {
                html += `
                    <div style="background: white; padding: 15px; margin-bottom: 15px; border-radius: 6px; border-left: 4px solid #667eea;">
                        <h4 style="margin: 0 0 10px 0; color: #4a5568;">
                            üèôÔ∏è ${city.city} (${city.country})
                        </h4>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            üìç Ubicaci√≥n: ${city.location}<br>
                            üó£Ô∏è Idioma: ${city.language === 'es' ? 'Espa√±ol' : 'Ingl√©s'}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>üîç T√©rminos de b√∫squeda:</strong><br>
                            ${city.search_terms.map(term => `<span style="background: #e6fffa; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 5px;">${term}</span>`).join('')}
                        </div>
                        <div>
                            <strong>üéØ Keywords de detecci√≥n:</strong><br>
                            ${city.keywords.map(kw => `<span style="background: #fff5f5; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-right: 5px;">${kw}</span>`).join('')}
                            ${city.total_keywords > 5 ? `<span style="color: #666; font-size: 12px;">... +${city.total_keywords - 5} m√°s</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    <div style="background: #e6fffa; padding: 10px; border-radius: 6px; text-align: center;">
                        <strong style="color: #2d3748;">‚úÖ B√∫squeda optimizada para ${optimization.length} ciudad(es)</strong>
                    </div>
                </div>
            `;
            
            // Insertar despu√©s del form
            const form = document.querySelector('.card');
            const preview = document.createElement('div');
            preview.innerHTML = html;
            preview.id = 'optimization-preview';
            
            // Remover preview anterior si existe
            const existingPreview = document.getElementById('optimization-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            form.parentNode.insertBefore(preview, form.nextSibling);
        }

        // Funciones para LinkedIn Invitations
        async function showLinkedInInviteModal() {
            // Primero cargar leads disponibles
            await loadResults();
            
            const modal = document.createElement('div');
            modal.id = 'linkedin-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; 
                    max-height: 80vh; overflow-y: auto;
                ">
                    <h3 style="margin-bottom: 20px; color: #0077b5;">
                        <i class="fab fa-linkedin"></i> Enviar Invitaciones LinkedIn
                    </h3>
                    
                    <div id="leads-selection" style="margin-bottom: 20px;">
                        <h4>Seleccionar Leads:</h4>
                        <div id="leads-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                            Cargando leads...
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="invitation-message" style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Mensaje de Invitaci√≥n Personalizado:
                        </label>
                        <textarea id="invitation-message" rows="6" style="
                            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
                            font-family: 'Segoe UI', sans-serif; resize: vertical;
                        " placeholder="¬°Hola! Me gustar√≠a conectar contigo para explorar oportunidades de colaboraci√≥n en medicina est√©tica...">${getDefaultInvitationMessage()}</textarea>
                        <small style="color: #666;">M√°ximo 300 caracteres (l√≠mite de LinkedIn)</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeLinkedInModal()" style="
                            padding: 10px 20px; border: 1px solid #ddd; background: white; 
                            border-radius: 6px; cursor: pointer;
                        ">Cancelar</button>
                        
                        <button onclick="sendLinkedInInvitations()" style="
                            padding: 10px 20px; background: #0077b5; color: white; border: none; 
                            border-radius: 6px; cursor: pointer;
                        ">
                            <i class="fab fa-linkedin"></i> Enviar Invitaciones
                        </button>
                    </div>
                    
                    <div id="invitation-progress" style="margin-top: 20px; display: none;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0077b5;">
                            <h4 style="margin: 0 0 10px 0; color: #0077b5;">Enviando Invitaciones...</h4>
                            <div id="invitation-status">Iniciando proceso...</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cargar lista de leads
            loadLeadsForInvitation();
        }
        
        function closeLinkedInModal() {
            const modal = document.getElementById('linkedin-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function loadLeadsForInvitation() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();
                
                const leadsList = document.getElementById('leads-list');
                
                if (data && data.results && data.results.length > 0) {
                    let html = '';
                    
                    data.results.forEach((result, index) => {
                        if (result.linkedin_results && result.linkedin_results.length > 0) {
                            result.linkedin_results.forEach((lead, leadIndex) => {
                                if (lead.linkedin_url && lead.linkedin_url !== 'URL no encontrada') {
                                    html += `
                                        <div style="
                                            padding: 10px; border: 1px solid #eee; margin-bottom: 8px; 
                                            border-radius: 6px; display: flex; align-items: center;
                                        ">
                                            <input type="checkbox" id="lead-${index}-${leadIndex}" 
                                                   value="${JSON.stringify(lead).replace(/"/g, '&quot;')}" 
                                                   checked style="margin-right: 10px;">
                                            <label for="lead-${index}-${leadIndex}" style="flex: 1; cursor: pointer;">
                                                <strong>${lead.name || 'Sin nombre'}</strong><br>
                                                <small style="color: #666;">
                                                    <i class="fab fa-linkedin"></i> ${lead.linkedin_url}
                                                </small>
                                            </label>
                                        </div>
                                    `;
                                }
                            });
                        }
                    });
                    
                    if (html === '') {
                        leadsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay leads con URLs de LinkedIn disponibles.</p>';
                    } else {
                        leadsList.innerHTML = html;
                    }
                } else {
                    leadsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay leads disponibles. Ejecuta una b√∫squeda primero.</p>';
                }
            } catch (error) {
                console.error('Error loading leads:', error);
                document.getElementById('leads-list').innerHTML = '<p style="color: #e53e3e;">Error cargando leads.</p>';
            }
        }
        
        function getDefaultInvitationMessage() {
            return `¬°Hola! Soy de una empresa de distribuci√≥n de productos de medicina est√©tica premium.

Me gustar√≠a conectar contigo para explorar oportunidades de colaboraci√≥n en fillers, botox y otros tratamientos innovadores.

¬øTe interesar√≠a conocer m√°s sobre nuestros productos y servicios?

¬°Saludos!`;
        }
        
        async function sendLinkedInInvitations() {
            const checkboxes = document.querySelectorAll('#leads-list input[type="checkbox"]:checked');
            const message = document.getElementById('invitation-message').value;
            
            if (checkboxes.length === 0) {
                alert('Por favor selecciona al menos un lead para enviar invitaciones.');
                return;
            }
            
            if (!message.trim()) {
                alert('Por favor escribe un mensaje de invitaci√≥n.');
                return;
            }
            
            if (message.length > 300) {
                alert('El mensaje debe tener m√°ximo 300 caracteres.');
                return;
            }
            
            const leads = Array.from(checkboxes).map(cb => JSON.parse(cb.value.replace(/&quot;/g, '"')));
            
            // Mostrar progreso
            document.getElementById('invitation-progress').style.display = 'block';
            document.getElementById('invitation-status').innerHTML = `Enviando ${leads.length} invitaciones...`;
            
            try {
                const response = await fetch('/api/send_linkedin_invites', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        leads: leads,
                        message: message
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('invitation-status').innerHTML = `
                        ‚úÖ Proceso iniciado para ${result.leads_count} leads.<br>
                        <small>Revisa los logs del sistema para ver el progreso en tiempo real.</small>
                    `;
                    
                    // Activar polling para resultados
                    pollInvitationResults();
                } else {
                    document.getElementById('invitation-status').innerHTML = `‚ùå Error: ${result.error}`;
                }
                
            } catch (error) {
                console.error('Error sending invitations:', error);
                document.getElementById('invitation-status').innerHTML = '‚ùå Error enviando invitaciones.';
            }
        }
        
        async function pollInvitationResults() {
            const maxPolls = 60; // 5 minutos m√°ximo
            let polls = 0;
            
            const pollInterval = setInterval(async () => {
                polls++;
                
                try {
                    const response = await fetch('/api/linkedin_invite_results');
                    const results = await response.json();
                    
                    if (results.total > 0) {
                        const statusDiv = document.getElementById('invitation-status');
                        statusDiv.innerHTML = `
                            üìä Resultados: ${results.sent} enviadas, ${results.failed} fallaron de ${results.total} total<br>
                            <small>Revisa los logs para m√°s detalles.</small>
                        `;
                        
                        // Si termin√≥ o alcanz√≥ l√≠mite de polling, parar
                        if ((results.sent + results.failed) >= results.total || polls >= maxPolls) {
                            clearInterval(pollInterval);
                            
                            setTimeout(() => {
                                closeLinkedInModal();
                            }, 3000);
                        }
                    }
                    
                } catch (error) {
                    console.error('Error polling results:', error);
                }
                
                if (polls >= maxPolls) {
                    clearInterval(pollInterval);
                }
            }, 5000); // Poll cada 5 segundos
        }
        
        async function openLinkedInInviteModal() {
            // Cargar leads con LinkedIn URLs
            await loadLinkedInLeads();
            
            // Mostrar el modal
            document.getElementById('linkedin-modal').style.display = 'block';
            
            // Resetear el formulario
            document.getElementById('invitation-message').value = getDefaultInvitationMessage();
            document.getElementById('invitation-progress').style.display = 'none';
            document.getElementById('invitation-status').innerHTML = '';
        }
        
        function closeLinkedInModal() {
            document.getElementById('linkedin-modal').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera de √©l
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('linkedin-modal');
            if (event.target === modal) {
                closeLinkedInModal();
            }
        });

        // Funciones para manejo de industrias
        async function changeIndustry() {
            const industrySelect = document.getElementById('industry');
            const selectedIndustry = industrySelect.value;
            
            try {
                addLog('INFO', `üîÑ Cambiando a industria: ${selectedIndustry}`);
                
                const response = await fetch('/api/change_industry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        industry_type: selectedIndustry
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    addLog('SUCCESS', `‚úÖ ${result.message}`);
                    
                    // Actualizar keywords predeterminadas
                    if (result.industry_info && result.industry_info.keywords) {
                        const keywordsInput = document.getElementById('keywords');
                        keywordsInput.value = result.industry_info.keywords.slice(0, 3).join(', ');
                        
                        addLog('INFO', `üéØ Keywords actualizadas para ${result.industry_info.name}`);
                    }
                } else {
                    addLog('ERROR', `‚ùå Error: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error changing industry:', error);
                addLog('ERROR', '‚ùå Error de conexi√≥n al cambiar industria');
            }
        }

        async function loadAvailableIndustries() {
            try {
                const response = await fetch('/api/industries');
                const result = await response.json();
                
                if (response.ok) {
                    const industrySelect = document.getElementById('industry');
                    
                    // Limpiar opciones actuales
                    industrySelect.innerHTML = '';
                    
                    // Agregar opciones disponibles
                    result.industries.forEach(industry => {
                        const option = document.createElement('option');
                        option.value = industry;
                        
                        // Nombres m√°s amigables
                        const friendlyNames = {
                            'medical_aesthetics': 'Medicina Est√©tica'
                        };
                        
                        option.textContent = friendlyNames[industry] || industry;
                        
                        if (industry === result.current) {
                            option.selected = true;
                        }
                        
                        industrySelect.appendChild(option);
                    });
                    
                    console.log('Industries loaded:', result.industries);
                } else {
                    console.error('Error loading industries:', result.error);
                }
                
            } catch (error) {
                console.error('Error loading industries:', error);
            }
        }

        // Cargar industrias al inicializar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableIndustries();
        });

        // Funciones para modal de agregar lead manual
        function showAddManualLeadModal() {
            document.getElementById('addManualLeadModal').style.display = 'block';
        }

        function closeAddManualLeadModal() {
            document.getElementById('addManualLeadModal').style.display = 'none';
            document.getElementById('manualLeadForm').reset();
        }

        // Cerrar modal al hacer clic fuera de √©l
        window.onclick = function(event) {
            const modal = document.getElementById('addManualLeadModal');
            if (event.target == modal) {
                closeAddManualLeadModal();
            }
        }

        // Manejar env√≠o del formulario
        document.getElementById('manualLeadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Mostrar estado de carga
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(e.target);
                const data = {
                    nombre: formData.get('nombre'),
                    email: formData.get('email'),
                    telefono: formData.get('telefono'),
                    linkedin_url: formData.get('linkedin_url'),
                    description: formData.get('description'),
                    industria: 'medical_aesthetics' // Por ahora fijo
                };
                
                const response = await fetch('/api/add_manual_lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // √âxito - mostrar mensaje y cerrar modal
                    alert(`‚úÖ ${result.message}`);
                    closeAddManualLeadModal();
                    
                    // Actualizar estad√≠sticas
                    loadDatabaseStats();
                } else {
                    // Error - mostrar mensaje
                    alert(`‚ùå Error: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error enviando lead manual:', error);
                alert('‚ùå Error de conexi√≥n al enviar el lead');
            } finally {
                // Restaurar bot√≥n
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Manejar formulario visible de lead manual
        document.getElementById('quickLeadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const resultDiv = document.getElementById('quickLeadResult');
            const originalText = submitBtn.innerHTML;
            
            // Mostrar estado de carga
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            submitBtn.disabled = true;
            resultDiv.innerHTML = '<div style="color: #007bff; padding: 10px; background: #e3f2fd; border-radius: 5px;">‚è≥ Guardando lead en base de datos...</div>';
            
            try {
                const formData = new FormData(e.target);
                const data = {
                    nombre: formData.get('nombre'),
                    email: formData.get('email'),
                    telefono: formData.get('telefono'),
                    linkedin_url: formData.get('linkedin_url'),
                    description: formData.get('description'),
                    industria: 'medical_aesthetics'
                };
                
                const response = await fetch('/api/add_manual_lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // √âxito - mostrar mensaje y limpiar formulario
                    resultDiv.innerHTML = `
                        <div style="color: #28a745; padding: 15px; background: #d4edda; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <strong>‚úÖ ¬°Lead agregado exitosamente!</strong><br>
                            <span style="font-size: 14px;">${result.message} (ID: ${result.lead_id})</span><br>
                            <small style="color: #155724;">üéØ Aparecer√° como "LinkedIn (Manual)" en las estad√≠sticas</small>
                        </div>
                    `;
                    e.target.reset();
                    
                    // Actualizar estad√≠sticas
                    loadDatabaseStats();
                    
                    // Ocultar mensaje despu√©s de 5 segundos
                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                    }, 5000);
                } else {
                    // Error - mostrar mensaje
                    resultDiv.innerHTML = `
                        <div style="color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb;">
                            <strong>‚ùå Error al guardar:</strong><br>
                            ${result.error}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error enviando lead manual:', error);
                resultDiv.innerHTML = `
                    <div style="color: #dc3545; padding: 15px; background: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <strong>‚ùå Error de conexi√≥n:</strong><br>
                        No se pudo conectar con el servidor
                    </div>
                `;
            } finally {
                // Restaurar bot√≥n
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Funciones para consultas de base de datos
        function executeQuery() {
            const queryText = document.getElementById('sql-query').value.trim();
            const resultsDiv = document.getElementById('query-results');
            
            if (!queryText) {
                resultsDiv.innerHTML = '‚ö†Ô∏è Por favor, introduce una consulta SQL';
                return;
            }
            
            resultsDiv.innerHTML = '‚è≥ Ejecutando consulta...';
            
            fetch('/api/execute_query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: queryText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultsDiv.innerHTML = `‚ùå Error: ${data.error}`;
                } else {
                    displayQueryResults(data.results, data.columns, resultsDiv);
                }
            })
            .catch(error => {
                resultsDiv.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
            });
        }

        function displayQueryResults(results, columns, container) {
            if (!results || results.length === 0) {
                container.innerHTML = 'üìÑ No se encontraron resultados';
                return;
            }
            
            let output = `<div class="alert alert-success mb-3">‚úÖ Consulta ejecutada exitosamente. ${results.length} resultado(s) encontrado(s).</div>`;
            
            // Crear tabla HTML con estilos Bootstrap
            if (columns && columns.length > 0) {
                output += `
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>`;
                
                columns.forEach(col => {
                    output += `<th>${col}</th>`;
                });
                
                output += `</tr></thead><tbody>`;
                
                results.forEach(row => {
                    output += '<tr>';
                    columns.forEach(col => {
                        let value = row[col];
                        
                        // Formatear valores especiales
                        if (value === null || value === undefined) {
                            value = '<em class="text-muted">NULL</em>';
                        } else if (typeof value === 'string' && value.includes('http')) {
                            // Hacer enlaces clickeables
                            if (value.includes('linkedin.com')) {
                                value = `<a href="${value}" target="_blank" class="text-primary"><i class="fab fa-linkedin"></i> Ver perfil</a>`;
                            } else {
                                value = `<a href="${value}" target="_blank" class="text-primary">${value}</a>`;
                            }
                        } else if (typeof value === 'boolean') {
                            value = value ? '<span class="text-success">‚úì</span>' : '<span class="text-danger">‚úó</span>';
                        } else if (typeof value === 'string' && value.includes('@')) {
                            // Emails clickeables
                            value = `<a href="mailto:${value}" class="text-info">${value}</a>`;
                        }
                        
                        output += `<td>${value}</td>`;
                    });
                    output += '</tr>';
                });
                
                output += '</tbody></table></div>';
            } else {
                output += `<pre class="bg-light p-3">${JSON.stringify(results, null, 2)}</pre>`;
            }
            
            container.innerHTML = output;
        }

        function clearQueryResults() {
            document.getElementById('query-results').innerHTML = 'üí° Los resultados aparecer√°n aqu√≠...';
            document.getElementById('sql-query').value = '';
        }

        function setQuickQuery(queryType) {
            const queryTextarea = document.getElementById('sql-query');
            
            const queries = {
                allLeads: 'SELECT id, nombre, email, telefono, linkedin_url, source, created_at FROM leads ORDER BY created_at DESC LIMIT 20',
                linkedinManual: 'SELECT id, nombre, email, telefono, linkedin_url, description, created_at FROM leads WHERE source = \'LinkedIn (Manual)\' ORDER BY created_at DESC',
                bySource: 'SELECT source, COUNT(*) as total_leads, COUNT(email) as with_email, COUNT(telefono) as with_phone FROM leads GROUP BY source ORDER BY total_leads DESC',
                recentLeads: 'SELECT nombre, source, email, telefono, created_at FROM leads WHERE created_at >= CURRENT_DATE - INTERVAL \'7 days\' ORDER BY created_at DESC',
                withEmail: 'SELECT nombre, email, telefono, linkedin_url, source, created_at FROM leads WHERE email IS NOT NULL AND email != \'\' ORDER BY created_at DESC',
                withPhone: 'SELECT nombre, telefono, email, linkedin_url, source, created_at FROM leads WHERE telefono IS NOT NULL AND telefono != \'\' ORDER BY created_at DESC'
            };
            
            if (queries[queryType]) {
                queryTextarea.value = queries[queryType];
                // Auto-ejecutar la consulta
                executeQuery();
            }
        }

        // Refresh status every 30 seconds
        setInterval(updateStatus, 30000);
    </script>
</body>
</html>